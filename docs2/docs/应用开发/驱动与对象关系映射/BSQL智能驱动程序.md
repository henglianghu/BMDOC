

除了兼容的上游PostgreSQL驱动程序外，BMDB还支持智能驱动程序，它扩展了PostgreSQL的驱动程序，使客户端应用程序能够连接到BMDB集群，而不需要外部负载均衡器。

BMDB为BSQL开发了以下智能驱动程序，可作为Apache 2.0许可证下的开源软件使用。

| GitLab 项目                           | 基于                     | 文档          |
| ------------------------------------- | ------------------------ | ------------- |
| BMDB JDBC Driver for Java             | PostgreSQL JDBC Driver   | Documentation |
| BMDB PGX Driver for Go                | jackc/pgx                | Documentation |
| BMDB Psycopg2 Driver for Python       | PostgreSQL psycopg2      | Documentation |
| BMDB node-postgres Driver for Node.js | node-postgres            | Documentation |
| BMDB Npgsql Driver for C#             | PostgreSQL Npgsql Driver | Documentation |
| BMDB Rust-postgres Driver             | Rust-Postgres Driver     | Documentation |

所有BMDB 智能驱动程序库都得到了维护，并接受了错误修复、性能增强和安全补丁 。

## **主要功能**

BMDB 智能驱动程序具有以下关键功能：

| 功能             | 说明                                                         |
| ---------------- | ------------------------------------------------------------ |
| 多个主机         | 与上游驱动程序（node.js除外）一样，您可以为初始连接指定多个主机，以避免在主不可用的情况下断开连接。 |
| 集群感知         | 智能驱动程序执行自动统一连接负载平衡在驱动程序建立初始连接后，它从集群中获取可用服务器的列表，并在这些服务器之间均匀分布连接。 |
| 拓扑感知         | 如果您想限制到特定地理位置的连接以实现更低的延迟，可以针对特定区域、区域和回退区域来平衡连接。 |
| 可配置的刷新间隔 | 默认情况下，驱动程序每五分钟刷新一次可用服务器的列表。间隔是可配置的（Python除外）。 |
| 连接池           | 与上游驱动程序一样，智能驱动程序支持流行的连接池解决方案。   |

## **概述**

BMDB 是一个分布式、容错、高可用的数据库，具有较低的读写延迟。BMDB 中的数据在多个节点之间自动进行分片、复制和平衡，这些节点可能位于不同的可用性区域和地区。为了获得更好的性能和容错性，您还可以平衡宇宙中各节点之间的应用程序流量（数据库连接），以避免任何单个节点上的CPU和内存负载过大。 

您可以通过以下方式对应用程序与数据库的连接进行负载平衡：

* 外部负载平衡器
* 集群感知智能驱动程序

### **使用外部负载平衡器**

由于BMDB 与PostgreSQL功能兼容，应用程序可以使用许多广泛可用的PostgreSQL客户端驱动程序连接到BMDB 集群。然而，这些驱动程序被设计用于具有单个网络地址的单片数据库。当他们连接到分布式数据库时，他们不明白数据库由多个可以连接的节点组成。绕过这一限制的一种方法是将节点放在一个或多个外部负载均衡器后面。 

然而，这种方法会导致复杂的配置并增加管理开销。例如，数据库集群端点抽象数据库集群中发生的角色更改（主发生选举）和拓扑更改（实例的添加和删除），并且DNS更新不是即时的。此外，它们可能导致数据库事件发生的时间与应用程序注意到和处理该事件的时间之间的延迟稍长。 

![](./media/chapter3/18.png)
### **智能驱动的优势**

智能客户端驱动程序允许应用程序通过连接到分布式SQL数据库集群中的任何节点来获得更好的性能和容错性，而不需要外部负载均衡器。

智能驱动程序经过优化，可与分布式SQL数据库一起使用，并且具有集群意识和拓扑意识；驱动跟踪集群的成员及其位置。在集群中添加或删除节点时，驱动程序会更新其成员身份和拓扑信息。驱动程序从元数据表中读取数据库集群拓扑，并在不依赖高级集群端点的情况下将新连接路由到各个实例端点。智能驱动程序还能够在可用的BM -dbservers上实现只读连接的负载平衡。 

与PostgreSQL驱动程序相比，智能驱动程序具有以下优势：

* 通过消除负载平衡器简化操作。因为PostgreSQL驱动程序是为单节点数据库设计的，所以它们不会跟踪分布式数据库集群的节点或它们的位置。客户依赖外部负载均衡器将请求路由到数据库集群中的不同节点，这增加了操作开销。智能驱动程序消除了对外部负载平衡器的需求。 
* 通过连接到附近的节点来提高性能。客户端应用程序可以识别并连接到离它们最近的数据库集群节点，以实现更低的延迟。 
* 通过更好的故障处理提高可用性。如果数据库节点由于网络问题或服务器故障而无法访问，则客户端可以连接到群集中的其他节点。客户端上的重试逻辑可以使故障对最终用户透明。

## **使用BMDB智能驱动程序**

开发人员可以在两种配置中使用智能驱动程序连接负载平衡：

* 集群感知，使用负载平衡连接参数
* 拓扑感知，使用拓扑密钥连接参数

在这两种情况下，驱动程序都会尝试连接到可用服务器组中负载最小的服务器。对于拓扑感知负载平衡，此组由使用拓扑密钥连接参数指定的地理位置确定。 

### **支持集群的连接负载平衡**

使用集群感知（也称为统一）连接负载平衡，无论连接的位置如何，都可以在集群中的所有BM dbserver上均匀分布连接。

例如，如果一个客户端应用程序创建了一百个到由十个节点组成的BMDB的连接，那么驱动程序会创建到每个节点的十个连接。如果连接的数量不能完全被服务器的数量整除，那么一些服务器可能比其他服务器少一个或多一个连接。这是负载的客户端视图，因此如果其他客户端应用程序未使用智能驱动程序，则服务器可能无法很好地平衡。

连接的工作原理如下：

* 驱动程序与URL或连接字符串中指定的主机进行初始连接。如果与主的连接失败，可以指定多个主机作为备份。
* 驱动程序使用bm_servers（）函数获取有关节点的信息。默认情况下，此列表每5分钟刷新一次，当收到新的连接请求时会检查此时间。
* 然后，驱动程序在将连接返回到应用程序之前连接到负载最少的节点。

#### 启用负载平衡

若要启用集群感知负载平衡，请在连接URL或连接字符串（DSN样式）中将负载平衡连接参数设置为true。

例如，使用Go智能驱动程序，可以按如下方式启用负载平衡：

```
"postgres://username:password@host:2521/database_name?load_balance=true"
```

通过在URL中指定此参数，驱动程序从BMDB中可用的给定端点获取并维护节点列表，并在这些节点之间平均分配连接。

在与节点建立连接后，如果该节点失败，则不重试请求。

为了使连接均匀分布，应用程序必须使用相同的连接URL来创建所需的每个连接。

请注意，为了实现负载平衡，节点必须是可访问的。例如，如果集群有多个区域部署在不同的VPC中，您的应用程序将需要访问所有区域，通常是通过对等 

#### 服务器刷新间隔

要更改驱动程序获取更新的服务器列表的频率，请指定服务器刷新间隔参数。

例如，使用Go智能驱动程序，可以将间隔更改为四分钟（以秒为单位），如下所示： 

```
"postgres://username:password@host:2521/database_name?load_balance=true&bm_servers_refresh_interval=240"
```

（请注意，目前BMDB Python智能驱动程序中不提供此功能。）

### **拓扑感知连接负载平衡**

对于跨多个区域的数据库部署，在所有数据库节点上均匀分布请求可能不是最佳的。使用拓扑感知的连接负载平衡，您可以针对指定地理位置的节点。然后，驱动程序将连接均匀地分布在指定位置的节点之间。这在以下情况下是有益的： 

* 用于连接到地理位置最近的区域和区域，以获得更低的延迟和更少的网络跳数。通常，您会将应用程序放在区域中。拓扑平衡允许您仅针对承载应用程序的区域。
* 已指定了首选位置，所有分片Leader都位于该位置。在这种情况下，为了获得最佳性能，您希望应用程序以首选位置为目标。 

您还可以指定回退位置以及尝试回退的顺序。当主位置中没有可用的节点时，驱动程序会尝试按指定的顺序连接到回退位置中的节点。例如，通过这种方式，您可以将目标锁定在地理位置最近的下一个位置，以防第一个位置不可用。
如果不提供回退位置，当主位置中没有可用的节点时，驱动程序将回退到整个集群中的节点 

#### 拓扑键

您可以将位置指定为拓扑键，其值格式为cloud.region.zone。可以将多个区域指定为逗号分隔的值。您可以在连接URL或连接字符串（DSN样式）中指定拓扑键。您仍然需要将负载平衡指定为true，以启用拓扑感知连接负载平衡。 

例如，使用Go驱动程序，可以按如下方式设置参数： 

```
"postgres://username:password@localhost:2521/database_name?load_balance=true&topology_keys=cloud1.region1.zone1,cloud1.region1.zone2"
```

使用星号（*）指定区域中的所有分区。（不能对区域或云执行此操作。）例如： 

```
"postgres://username:password@localhost:2521/database_name?load_balance=true&topology_keys=cloud1.region1.*"
```

#### 回退拓扑密钥

若要在某个位置不可用时指定回退位置，请在拓扑键中添加：n，其中n是表示优先级的整数。以下示例将zone1设置为拓扑关键字，如果无法到达zone1，则将zon2和zon3设置为回退（按顺序）：

```
"postgres://username:password@localhost:2521/database_name?load_balance=true&topology_keys=cloud1.region1.zone1:1,cloud1.region1.zone2:2,cloud1.region1.zone3:3"
```

不指定优先级等同于将优先级设置为1。
如果没有可用的服务器，则请求可能会失败返回 

### **连接池**

智能驱动程序可以使用Hikari和Tomcat等流行的池化解决方案进行配置。如果需要，可以使用不同的负载平衡策略配置不同的池。例如，应用程序可以为一个区域及其可用性区域配置一个具有拓扑意识的池，并将另一个池配置为与完全不同的区域通信。

适当的连接超时取决于应用程序的特定要求。除了通常的注意事项外，由于BMDB 是分布式的，您还希望连接尽快移动到已恢复或新添加的节点。

当连接达到超时时，池会重新建立到连接数量最少的节点的新连接，该节点很可能是新节点。将超时设置得太长，可能无法最大限度地利用新节点。例如，10分钟的超时意味着新节点可能在长达10分钟的时间内无法接收连接。（该节点仍将用于BM dbserver操作，但不用于新的客户端连接。）但是，将超时设置得太短会由于第一次连接延迟过高而降低总体延迟性能。使用不同的超时值进行实验，并监视应用程序和数据库的性能以确定最佳值。 